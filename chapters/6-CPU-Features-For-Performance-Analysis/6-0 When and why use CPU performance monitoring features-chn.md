---
typora-root-url: ..\..\img
---

# CPU Features For Performance Analysis {#sec:sec4}

性能分析的最终目标是识别瓶颈并在代码中找到与之相关的位置。不幸的是，没有预先确定的步骤可以遵循，因此可以通过许多不同的方式来处理它。

通常，分析应用程序可以快速了解应用程序的热点。有时，开发人员需要做的就是解决性能低下的问题。特别是高级性能问题通常可以通过分析来揭示。例如，考虑一个对特定功能感兴趣的应用程序的分析情况。根据您对应用程序的心智模型，您希望该功能是冷的。但是当你打开配置文件时，你会看到它消耗了大量的时间，并且被调用了很多次。基于这些信息，您可以应用缓存或记忆等技术来减少对该函数的调用次数，并期望看到显着的性能提升。

但是，当您修复了所有主要的性能低效问题，但仍需要从应用程序中榨取更多性能时，诸如花在特定功能上的时间等基本信息是不够的。这是您需要 CPU 的额外支持以了解性能瓶颈所在的时候。因此，在使用本章介绍的信息之前，请确保您尝试优化的应用程序没有出现重大性能缺陷。因为如果是这样，使用 CPU 性能监控功能进行低级调优就没有意义了。它可能会将您引向错误的方向，而不是修复真正的高级性能问题，您将调整错误的代码，这只是浪费时间。

\personal{当我开始进行性能优化工作时，我通常只是对应用程序进行概要分析，并尝试通过基准测试的热点来把握，希望在那里找到一些东西。这经常使我对展开、矢量化、内联等进行随机实验。我并不是说这总是一种失败的策略。有时你可以很幸运地从随机实验中获得巨大的性能提升。但通常，你需要有很好的直觉和运气。}

现代 CPU 不断获得以不同方式增强性能分析的新功能。使用这些功能可以大大简化查找缓存未命中、分支错误预测等低级问题的过程。在本章中，我们将了解现代 Intel CPU 上可用的一些硬件性能监控功能。它们中的大多数也有来自其他供应商（如 AMD、ARM 等）的 CPU 对应物。在相应部分中查找更多详细信息。

* 自上而下的微架构分析方法 (TMA) - 一种强大的技术，用于识别程序对 CPU 微架构的无效使用。它描述了工作负载的瓶颈，并允许在源代码中找到它发生的确切位置。它抽象出 CPU 微架构的复杂性，即使对于没有经验的开发人员也很容易使用。
* Last Branch Record (LBR) - 一种在执行程序的同时连续记录最新分支结果的机制。它用于收集调用堆栈、识别热分支、计算单个分支的误预测率等等。
* 基于处理器事件的采样 (PEBS) - 一种增强采样的功能。其主要优点包括：降低采样开销并提供“精确事件”功能，允许精确定位导致特定性能事件的精确指令。
* 英特尔处理器跟踪 (PT) - 一种记录和重建程序执行的工具，每条指令都带有时间戳。它的主要用途是事后分析和根本原因的性能故障。

上述功能提供了从 CPU 角度了解程序效率以及如何使其对 CPU 更加友好的见解。分析工具利用它们来提供许多不同类型的性能分析。
