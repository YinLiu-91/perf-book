---
typora-root-url: ..\..\img
---

## Noise In Modern Systems {#sec:secFairExperiments}

硬件和软件中有许多旨在提高性能的功能。但并非所有人都具有确定性行为。让我们考虑 [动态频率缩放](https://en.wikipedia.org/wiki/Dynamic_frequency_scaling)[^11] (DFS)：这是一个允许 CPU 在短时间内增加频率的功能，使其运行速度明显更快。但是，CPU 无法长时间处于“超频”模式，因此稍后会将其频率降低回基准值。 DFS 通常在很大程度上取决于核心温度，这使得很难预测对我们实验的影响。

如果我们开始两次运行基准测试，在“冷”处理器[^1] 上依次运行，第一次运行可能会在“超频”模式下运行一段时间，然后将其频率降低回基本水平。但是，第二次运行可能没有此优势，并且将在基本频率下运行而无需进入“涡轮模式”。即使我们两次运行完全相同版本的程序，它们运行的​​环境也不相同。图@fig:FreqScaling 显示了动态频率缩放可能导致测量结果变化的情况。在笔记本电脑上进行基准测试时经常会发生这种情况，因为它们通常散热有限。

![由频率缩放引起的测量偏差。](/1/FreqScaling.jpg){#fig:FreqScaling width=80%}

频率缩放是硬件功能，但测量的变化也可能来自软件功能。让我们考虑一个文件系统缓存的例子。如果我们对执行大量文件操作的应用程序进行基准测试，则文件系统可以在性能方面发挥重要作用。当基准测试的第一次迭代运行时，文件系统缓存中所需的条目可能会丢失。但是，当第二次运行相同的基准测试时，文件系统缓存将被预热，使其比第一次运行快得多。

不幸的是，测量偏差不仅来自环境配置。 [@Mytkowicz] 论文证明 UNIX 环境大小（即存储环境变量所需的总字节数）和链接顺序（提供给链接器的目标文件的顺序）会以不可预知的方式影响性能。此外，还有许多其他方式会影响内存布局并可能影响性能测量。 [@STABILIZER] 中介绍了一种方法，可以在现代架构上对软件进行统计上合理的性能分析。这项工作表明，通过在运行时有效且重复地随机化代码、堆栈和堆对象的放置，可以消除来自内存布局的测量偏差。可悲的是，这些想法并没有走得更远，而现在，这个项目几乎被放弃了。

\personal{请记住，即使运行任务管理器工具，如 Linux top，也会影响测量，因为某些 CPU 内核将被激活并分配给它。这可能会影响运行实际基准测试的内核频率。}

进行一致的测量需要在相同条件下运行基准测试的所有迭代。但是，不可能复制完全相同的环境并完全消除偏差：可能存在不同的温度条件、功率传输峰值、相邻进程运行等。追逐系统中所有潜在的噪声源和变化可能是永远不可能的事情。结束的故事。有时无法实现，例如在对大型分布式云服务进行基准测试时。

因此，消除系统中的不确定性有助于定义明确的、稳定的性能测试，例如微基准测试。例如，当您实施一些代码更改并想通过对同一程序的两个不同版本进行基准测试来了解相对加速比时。在这种情况下，您可以控制基准测试中的大部分变量，包括其输入、环境配置等。在这种情况下，消除系统中的不确定性有助于获得更加一致和准确的比较。完成本地测试后，请记住确保预期的性能改进反映在实际测量中。读者可以在附录 A 中找到一些可以将噪声带入性能测量的功能示例以及如何禁用它们。此外，还有一些工具可以设置环境以确保基准测试结果具有低方差；其中之一是 [temci](https://github.com/parttimenerd/temci)[^14]。

在估计实际性能改进时，不建议消除系统的非确定性行为。工程师应该尝试复制他们正在优化的目标系统配置。对被测系统进行任何人工调整都会使结果与您的服务用户在实践中看到的结果不同。此外，任何性能分析工作，包括分析（参见 [@sec:profiling]），都应该在系统上完成

[^1]: By cold processor, I mean the CPU that stayed in an idle mode for a while, allowing it to cool down. 
[^11]: Dynamic Frequency Scaling - [https://en.wikipedia.org/wiki/Dynamic_frequency_scaling](https://en.wikipedia.org/wiki/Dynamic_frequency_scaling).
[^12]: Standard deviation - [https://en.wikipedia.org/wiki/Standard_deviation](https://en.wikipedia.org/wiki/Standard_deviation).
[^14]: Temci - [https://github.com/parttimenerd/temci](https://github.com/parttimenerd/temci).
