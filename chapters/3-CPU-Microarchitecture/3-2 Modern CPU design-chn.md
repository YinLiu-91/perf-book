---
typora-root-url: ..\..\img
---

## Modern CPU design

![Block diagram of a CPU Core in the Intel Skylake Microarchitecture. *© Image from [@IntelOptimizationManual].*](/uarch/skylake_block_diagram_v2.png){#fig:Skylake_diag width=95%}


图@fig:Skylake_diag中的框图详细展示了英特尔2015年发布并在全球广泛传播的第6代核心Skylake。 Skylake 核心分为一个有序前端，用于获取 x86 指令并将其解码为 u-ops 和一个 8 路超标量无序后端。

该内核支持 2 路 SMT。它有一个 32KB 的 8 路一级指令缓存（L1 I-cache）和一个 32KB 的 8 路一级数据缓存（L1 D-cache）。 L1 缓存由统一的 1MB 二级缓存 L2 缓存支持。 L1 和 L2 缓存对每个内核都是私有的。

### CPU 前端 {#sec:uarchFE}

CPU 前端由许多数据结构组成，其主要目标是有效地从内存中获取和解码指令。其主要目的是将准备好的指令提供给 CPU 后端，后者负责实际执行指令。

CPU 前端每周期从 L1 I-cache 获取 16 个字节的 x86 指令。这在两个线程之间共享，因此每个线程每隔一个周期获得 16 个字节。这些是复杂的、可变长度的 x86 指令。流水线的预解码和解码阶段将这些复杂的 x86 指令转换为微操作（UOP，请参阅 [@sec:sec_UOP]），这些微操作会排队进入指令解码队列 (IDQ)。

首先，预解码通过检查指令来确定和标记变量指令的边界。在 x86 中，指令长度的范围可以从 1 字节到 15 字节指令。这个阶段还识别分支指令。预解码阶段将最多 6 条指令（也称为宏指令）移动到在两个线程之间拆分的指令队列中。指令队列还支持一个宏操作融合单元，该单元检测两个宏指令可以融合为一条指令（参见 [@sec:sec_UOP]）。这种优化节省了管道其余部分的带宽。

每个周期最多从指令队列向解码器发送五个预解码指令。两个线程共享此接口并每隔一个周期访问一次。 5 路解码器将复杂的宏操作转换为固定长度的 UOP。

前端的主要性能提升功能是解码流缓冲区 (DSB) 或 UOP 缓存。其动机是将宏操作到 UOP 的转换缓存在与 L1 I-cache 并行工作的单独结构 (DSB) 中。在取指令期间，还会检查 DSB 以查看 UOP 转换是否已在 DSB 中可用。频繁发生的宏操作将在 DSB 中命中，并且流水线将避免为 16 字节包重复昂贵的预解码和解码操作。 DSB 提供六个 UOP，与前端到后端接口的容量相匹配，有助于保持整个内核的平衡。 DSB 与分支预测单元 BPU 协同工作。 BPU 预测所有分支指令的方向，并根据该预测引导下一条指令提取。

一些非常复杂的指令可能需要比解码器处理更多的 UOP。此类指令的 UOP 由 Microcode Sequencer (MSROM) 提供。此类指令的示例包括对字符串操作、加密、同步等的硬件操作支持。此外，MSROM 保留微码操作以处理异常情况，例如分支预测错误（需要流水线刷新）、浮点辅助（例如，当指令以非正规浮点值操作时）等。

指令解码队列 (IDQ) 提供了有序前端和无序后端之间的接口。 IDQ 按顺序排列 UOP。 IDQ 共有 128 个 UOP，每个硬件线程 64 个 UOP。

### CPU 后端 {#sec:uarchBE}

CPU 后端采用乱序引擎来执行指令并存储结果。

CPU 后端的核心是 224 项 ReOrder 缓冲区 (ROB)。该单元处理数据依赖关系。 ROB 将体系结构可见的寄存器映射到调度器/预留站单元中使用的物理寄存器。 ROB 还提供寄存器重命名和跟踪推测执行。 ROB 条目始终按程序顺序停用。

预留站/调度器 (RS) 是一种结构，用于跟踪给定 UOP 的所有资源的可用性，并在准备好后将 UOP 分派到指定的端口。内核是 8 路超标量。因此，RS 每个周期最多可以分派 8 个 UOP。如图@fig:Skylake_diag，每个调度端口支持不同的操作：

* 端口 0、1、5 和 6 提供所有整数、FP 和向量 ALU。分派到这些端口的 UOP 不需要内存操作。
* 端口 2 和 3 用于地址生成和加载操作。
* 端口 4 用于存储操作。
* 端口 7 用于地址生成。